<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Experience Research Study</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .block {
            display: none;
        }
        
        .block.active {
            display: block;
        }
        
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #007bff;
            margin-top: 30px;
        }
        
        .question {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        
        .radio-group {
            margin: 10px 0;
        }
        
        .radio-group label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .radio-group label:hover {
            background-color: #e9ecef;
        }
        
        .radio-group input[type="radio"] {
            margin-right: 12px;
        }
        
        .scale-group {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 15px 0;
            flex-wrap: nowrap;
            gap: 10px;
        }
        
        .scale-item {
            text-align: center;
            flex: 1;
            padding: 10px 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
            min-width: 0;
        }
        
        .scale-item:hover {
            background-color: #e9ecef;
        }
        
        .scale-item input[type="radio"] {
            display: block;
            margin: 0 auto 8px auto;
        }
        
        .scale-item label {
            font-size: 12px;
            line-height: 1.2;
            word-wrap: break-word;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .btn {
            background-color: #007bff;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 15px 5px;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #0056b3;
        }
        
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-submit {
            background-color: #28a745;
        }
        
        .btn-submit:hover {
            background-color: #218838;
        }
        
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 8px;
            padding: 8px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            display: none; /* Hide by default */
        }
        
        .error:not(:empty) {
            display: block; /* Only show when there's content */
        }
        
        .video-container {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .condition-header {
            background-color: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #b8daff;
        }
        
        .restaurant-scenario {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 25px;
            border-radius: 8px;
            margin: 25px 0;
        }
        
        .scenario-list {
            list-style-type: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .scenario-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .scenario-list li:last-child {
            border-bottom: none;
        }
        
        .word-counter {
            font-size: 13px;
            color: #6c757d;
            margin-top: 8px;
            text-align: right;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .data-export {
            margin-top: 30px;
            padding: 25px;
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 8px;
        }
        
        .warning-notice {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }
        
        .warning-notice::before {
            content: "‚ö†Ô∏è";
            font-size: 24px;
            position: absolute;
            left: 20px;
            top: 20px;
        }
        
        .warning-text {
            margin-left: 40px;
            font-weight: 500;
            color: #856404;
        }
        
        .location-prompt {
            background-color: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .completion-code {
            background-color: #d4edda;
            border: 3px solid #28a745;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .completion-code h3 {
            color: #155724;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .code-display {
            font-size: 36px;
            font-weight: bold;
            color: #28a745;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            letter-spacing: 3px;
        }
        
        .review-submitted {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #155724;
        }
        
        .review-locked {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            color: #6c757d;
            font-style: italic;
        }
        
        video {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .scale-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .scale-item {
                width: calc(50% - 10px);
                margin: 5px;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- Block 0: Location Collection -->
        <div class="block active" id="block0">
            <h1>Location Permission Required</h1>
            <div class="location-prompt">
                <h3>üìç Location Access</h3>
                <p>This study requires your location to proceed. Please allow location access when prompted by your browser.</p>
                <p><strong>Your location data will be used only for research purposes and will remain anonymous.</strong></p>
                <div id="locationStatus">Requesting location...</div>
                <button class="btn" id="requestLocationBtn" onclick="requestLocation()">Allow Location Access</button>
            </div>
        </div>

        <!-- Block 1: Prolific ID -->
        <div class="block" id="block1">
            <h1>Participant Information</h1>
            <div class="question">
                <h3>What is your Prolific ID?</h3>
                <input type="text" name="prolific_id" id="prolificId" placeholder="Enter your Prolific ID" required>
                <div class="error" id="prolificError"></div>
            </div>
            <button class="btn" onclick="nextBlock(1)">Continue</button>
        </div>

        <!-- Block 2: Warning and Consent -->
        <div class="block" id="block2">
            <h1>Consumer Experience Research Study</h1>
            
            <div class="warning-notice">
                <div class="warning-text">
                    <strong>IMPORTANT NOTICE:</strong> Random selection of responses will be identified by our AI algorithm and will disqualify your participation and payment. Please read all questions carefully and provide thoughtful, genuine responses throughout the study.
                </div>
            </div>
            
            <div class="question">
                <p><strong>Welcome to this study on consumer experiences.</strong></p>
                <p>You are invited to participate in an academic research study about how people describe their experiences with businesses. Your participation is voluntary and anonymous.</p>
                <p>The study involves participating in two tasks: (i) write a review of a restaurant based on a video you would watch; (ii) write a review based on text-based description of a restaurant. You will be compensated fully for your participation.</p>
                <p>Some responses may be reviewed for quality. Optional bonuses may be awarded for thoughtful participation.</p>
                <p>By continuing, you confirm that you are at least 18 years old and understand that participation is voluntary.</p>
                
                <h3>Q1. Do you consent to participate in this study?</h3>
                <div class="radio-group">
                    <label><input type="radio" name="consent" value="yes" required> Yes</label>
                    <label><input type="radio" name="consent" value="no"> No</label>
                </div>
                <div class="error" id="consentError"></div>
            </div>
            <button class="btn" onclick="nextBlock(2)">Continue</button>
        </div>

        <!-- Block 3: Political Identity -->
        <div class="block" id="block3">
            <h2>Political Views</h2>
            <div class="question">
                <h3>Q2. How would you describe your political views?</h3>
                <div class="scale-group">
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="1" required>
                        <label>1<br>Very liberal</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="2">
                        <label>2<br>Liberal</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="3">
                        <label>3<br>Somewhat liberal</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="4">
                        <label>4<br>Moderate</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="5">
                        <label>5<br>Somewhat conservative</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="6">
                        <label>6<br>Conservative</label>
                    </div>
                    <div class="scale-item">
                        <input type="radio" name="political_views" value="7">
                        <label>7<br>Very conservative</label>
                    </div>
                </div>
                <div class="error" id="politicalError"></div>
            </div>
            <button class="btn" onclick="nextBlock(3)">Continue</button>
        </div>

        <!-- Task 1: Video Review -->
        <div class="block" id="block4">
            <h2>Task 1: Video Based Review</h2>
            <div class="question">
                <h3>Q3. Please watch this short clip.</h3>
                <div class="video-container">
                    <iframe 
                        width="100%" 
                        height="400" 
                        src="https://www.youtube.com/embed/TpDG2LS1YpQ?rel=0&modestbranding=1&showinfo=0" 
                        title="Restaurant Video" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        allowfullscreen
                        style="max-width: 600px; border-radius: 8px;">
                    </iframe>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        If the video doesn't load, please refresh the page or check your internet connection.
                    </p>
                </div>
                <p>Assume that you are one of the guests in the restaurant shown in the clip. Note, the audio associated with the video file has been purposefully muted. Please write a review of this restaurant. (Minimum 25 words)</p>
                <textarea name="video_review" id="videoReview" placeholder="Write your Yelp-style review here..." oninput="countWords('videoReview', 'videoWordCount')"></textarea>
                <div class="word-counter" id="videoWordCount">Word count: 0 (minimum 25 words required)</div>
                <div class="error" id="videoReviewError"></div>
            </div>
            <button class="btn" onclick="nextBlock(4)">Continue</button>
        </div>

        <!-- Random Assignment Block -->
        <div class="block" id="block5">
            <h2>Task 2: Review Based on Textual Description</h2>
            <div class="condition-header" id="conditionHeader">
                <!-- Condition description will be inserted here -->
            </div>
            
            <div class="restaurant-scenario">
                <h3>Restaurant Scenario:</h3>
                <ul class="scenario-list">
                    <li><strong>Type:</strong> <span>New restaurant</span></li>
                    <li><strong>Price:</strong> <span>Moderately priced</span></li>
                    <li><strong>Style:</strong> <span>Casual dining</span></li>
                    <li><strong>Food:</strong> <span>Average</span></li>
                    <li><strong>Service:</strong> <span>Polite but slow</span></li>
                    <li><strong>Wait time:</strong> <span>10 mins to be seated, 25 mins for food</span></li>
                    <li><strong>Server:</strong> <span>Friendly</span></li>
                    <li><strong>Decor:</strong> <span>Minimal</span></li>
                    <li><strong>Music:</strong> <span>No background music</span></li>
                    <li><strong>Environment:</strong> <span>Clean environment</span></li>
                    <li><strong>Overall:</strong> <span>Decent, unremarkable</span></li>
                </ul>
            </div>
            
            <div class="question">
                <h3 id="conditionQuestion">Assume that you are one of the guests in the restaurant described above. Please write a review of this restaurant with the mindset of someone who resides in an area with the political complexion described above, even if that is not aligned with your personal political leanings. (Minimum 25 words)</h3>
                <div id="reviewContainer">
                    <textarea name="condition_review" id="conditionReview" placeholder="Write your Yelp-style review here..." oninput="countWords('conditionReview', 'conditionWordCount')"></textarea>
                    <div class="word-counter" id="conditionWordCount">Word count: 0 (minimum 25 words required)</div>
                    <div class="error" id="conditionReviewError"></div>
                    <button class="btn btn-submit" onclick="submitReview()">Submit Review</button>
                </div>
                <div id="reviewSubmitted" style="display: none;">
                    <div class="review-submitted">
                        ‚úÖ Review submitted successfully!
                    </div>
                    <div class="review-locked" id="lockedReview"></div>
                </div>
            </div>

            <!-- Follow-up Question (appears after review submission) -->
            <div id="followUpSection" style="display: none;">
                <div class="question">
                    <h3 id="followUpQuestion"><!-- Question will be inserted here --></h3>
                    <div class="scale-group">
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="1" required>
                            <label>1<br>Much less<br>comfortable</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="2">
                            <label>2<br>Less<br>comfortable</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="3">
                            <label>3<br>Slightly less<br>comfortable</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="4">
                            <label>4<br>About<br>the same</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="5">
                            <label>5<br>Slightly more<br>comfortable</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="6">
                            <label>6<br>More<br>comfortable</label>
                        </div>
                        <div class="scale-item">
                            <input type="radio" name="followup_comfort" value="7">
                            <label>7<br>Much more<br>comfortable</label>
                        </div>
                    </div>
                    <div class="error" id="followUpError"></div>
                    <button class="btn" onclick="nextBlock(5)">Continue</button>
                </div>
            </div>
        </div>

        <!-- Demographics -->
        <div class="block" id="block6">
            <h2>Demographics</h2>
            <div class="question">
                <h3>Q5. What is your age?</h3>
                <input type="number" name="age" id="age" min="18" max="120" placeholder="Enter your age">
                <div class="error" id="ageError"></div>
            </div>
            
            <div class="question">
                <h3>Q6. What is your gender?</h3>
                <div class="radio-group">
                    <label><input type="radio" name="gender" value="male" required> Male</label>
                    <label><input type="radio" name="gender" value="female"> Female</label>
                    <label><input type="radio" name="gender" value="non-binary"> Non-binary</label>
                    <label><input type="radio" name="gender" value="prefer-not-to-say"> Prefer not to say</label>
                </div>
                <div class="error" id="genderError"></div>
            </div>
            
            <div class="question">
                <h3>Q7. What is your highest level of education?</h3>
                <div class="radio-group">
                    <label><input type="radio" name="education" value="high-school" required> High school</label>
                    <label><input type="radio" name="education" value="some-college"> Some college</label>
                    <label><input type="radio" name="education" value="college-degree"> College degree</label>
                    <label><input type="radio" name="education" value="graduate-degree"> Graduate degree</label>
                </div>
                <div class="error" id="educationError"></div>
            </div>
            
            <div class="question">
                <h3>Q8. What is your ZIP code?</h3>
                <input type="text" name="zip_code" id="zipCode" placeholder="Enter your ZIP code" pattern="[0-9]{5}(-[0-9]{4})?" title="Please enter a valid ZIP code">
                <div class="error" id="zipError"></div>
            </div>
            
            <button class="btn" onclick="submitSurvey()">Submit Survey</button>
        </div>

        <!-- Completion Block -->
        <div class="block" id="blockComplete">
            <h1>Thank You!</h1>
            <p>Your responses have been submitted successfully. Thank you for participating in this research study.</p>
            
            <div class="completion-code">
                <h3>Your Completion Code</h3>
                <p>Please copy this code and enter it in Prolific to confirm your completion:</p>
                <div class="code-display">HP369</div>
                <p><strong>Important:</strong> You must enter this code in Prolific to receive your payment.</p>
            </div>
            
            <div class="data-export">
                <h3>Data Export</h3>
                <button class="btn" onclick="downloadData()">Download Your Data (JSON)</button>
                <div id="dataPreview" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Survey data storage
        let surveyData = {
            participant_id: generateParticipantId(),
            start_time: new Date().toISOString(),
            condition: null,
            location: null,
            responses: {}
        };

        // Condition definitions
        const conditions = {
            A: {
                title: "Democratic Region",
                description: "You are a frequent contributor on a local community review platform (similar to Yelp). Imagine that you currently reside in a county that identifies as Democratic.",
                question: "Q4. Please write a review of this restaurant. (Minimum 25 words)",
                followUpQuestion: "Now, imagine you are in a Republican county rather than a Democratic one. Would you feel more comfortable expressing your opinion openly in your review?"
            },
            B: {
                title: "Republican Region", 
                description: "You are a frequent contributor on a local community review platform (similar to Yelp). Imagine that you currently reside in a county that identifies as Republican.",
                question: "Q4. Please write a review of this restaurant. (Minimum 25 words)",
                followUpQuestion: "Now, imagine you are in a Democratic county rather than a Republican one. Would you feel more comfortable expressing your opinion openly in your review?"
            }
        };

        let currentBlock = 0;
        let totalBlocks = 6;
        let reviewSubmitted = false;

        function generateParticipantId() {
            return 'P' + Date.now() + Math.random().toString(36).substr(2, 5);
        }

        function updateProgress() {
            const progress = (currentBlock / totalBlocks) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function requestLocation() {
            const statusDiv = document.getElementById('locationStatus');
            const button = document.getElementById('requestLocationBtn');
            
            if (navigator.geolocation) {
                statusDiv.innerHTML = 'Requesting location access...';
                button.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        surveyData.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                        
                        statusDiv.innerHTML = '‚úÖ Location access granted! You can now proceed.';
                        button.style.display = 'none';
                        
                        setTimeout(() => {
                            nextBlock(0);
                        }, 1500);
                    },
                    function(error) {
                        statusDiv.innerHTML = '‚ùå Location access denied. Please allow location access to continue with the study.';
                        button.disabled = false;
                        button.textContent = 'Try Again';
                        
                        setTimeout(() => {
                            requestLocation();
                        }, 3000);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                statusDiv.innerHTML = '‚ùå Geolocation is not supported by this browser.';
            }
        }

        function countWords(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            const text = textarea.value.trim();
            const words = text === '' ? 0 : text.split(/\s+/).length;
            
            counter.textContent = `Word count: ${words} (minimum 25 words required)`;
            counter.style.color = words >= 25 ? '#28a745' : '#6c757d';
            
            return words;
        }

        function validateCurrentBlock() {
            const errors = {};
            
            switch(currentBlock) {
                case 1:
                    const prolificId = document.getElementById('prolificId').value.trim();
                    if (!prolificId) {
                        errors.prolific = 'Please enter your Prolific ID';
                    }
                    break;
                    
                case 2:
                    const consent = document.querySelector('input[name="consent"]:checked');
                    if (!consent) {
                        errors.consent = 'Please select an option';
                    } else if (consent.value === 'no') {
                        alert('Thank you for your time. This study requires consent to participate.');
                        return false;
                    }
                    break;
                    
                case 3:
                    if (!document.querySelector('input[name="political_views"]:checked')) {
                        errors.political = 'Please select your political views';
                    }
                    break;
                    
                case 4:
                    const videoWords = countWords('videoReview', 'videoWordCount');
                    if (videoWords < 25) {
                        errors.videoReview = 'Please write at least 25 words';
                    }
                    break;
                    
                case 6:
                    const age = document.getElementById('age').value;
                    if (!age || age < 18) {
                        errors.age = 'Please enter a valid age (18 or older)';
                    }
                    if (!document.querySelector('input[name="gender"]:checked')) {
                        errors.gender = 'Please select your gender';
                    }
                    if (!document.querySelector('input[name="education"]:checked')) {
                        errors.education = 'Please select your education level';
                    }
                    const zipCode = document.getElementById('zipCode').value;
                    if (!zipCode || !/^\d{5}(-\d{4})?$/.test(zipCode)) {
                        errors.zip = 'Please enter a valid ZIP code';
                    }
                    break;
            }
            
            // Display errors
            Object.keys(errors).forEach(field => {
                const errorElement = document.getElementById(field + 'Error');
                if (errorElement) {
                    errorElement.textContent = errors[field];
                }
            });
            
            // Clear previous errors
            document.querySelectorAll('.error').forEach(error => {
                if (!errors[error.id.replace('Error', '')]) {
                    error.textContent = '';
                }
            });
            
            return Object.keys(errors).length === 0;
        }

        function collectCurrentBlockData() {
            console.log(`üìù Collecting data for block ${currentBlock}...`);
            
            switch(currentBlock) {
                case 1:
                    const prolificId = document.getElementById('prolificId').value.trim();
                    surveyData.responses.prolific_id = prolificId;
                    console.log('‚úÖ Collected Prolific ID:', prolificId);
                    break;
                case 2:
                    const consent = document.querySelector('input[name="consent"]:checked')?.value;
                    surveyData.responses.consent = consent;
                    console.log('‚úÖ Collected consent:', consent);
                    break;
                case 3:
                    const politicalViews = document.querySelector('input[name="political_views"]:checked')?.value;
                    surveyData.responses.political_views = parseInt(politicalViews);
                    console.log('‚úÖ Collected political views:', politicalViews);
                    break;
                case 4:
                    const videoReview = document.getElementById('videoReview').value;
                    const videoWordCount = countWords('videoReview', 'videoWordCount');
                    surveyData.responses.video_review = videoReview;
                    surveyData.responses.video_review_word_count = videoWordCount;
                    console.log('‚úÖ Collected video review:', videoWordCount, 'words');
                    break;
                case 6:
                    const age = document.getElementById('age').value;
                    const gender = document.querySelector('input[name="gender"]:checked')?.value;
                    const education = document.querySelector('input[name="education"]:checked')?.value;
                    const zipCode = document.getElementById('zipCode').value;
                    
                    surveyData.responses.age = parseInt(age);
                    surveyData.responses.gender = gender;
                    surveyData.responses.education = education;
                    surveyData.responses.zip_code = zipCode;
                    surveyData.end_time = new Date().toISOString();
                    console.log('‚úÖ Collected demographics:', { age, gender, education, zipCode });
                    break;
            }
            
            console.log('üìä Updated survey data:', surveyData);
        }

        function randomizeCondition() {
            // 50-50 randomization between A and B
            const randomKey = Math.random() < 0.5 ? 'A' : 'B';
            surveyData.condition = randomKey;
            surveyData.responses.assigned_condition = randomKey;
            
            const condition = conditions[randomKey];
            document.getElementById('conditionHeader').innerHTML = `
                <h3>${condition.title}</h3>
                <p>${condition.description}</p>
            `;
            document.getElementById('conditionQuestion').textContent = condition.question;
        }

        function submitReview() {
            const conditionWords = countWords('conditionReview', 'conditionWordCount');
            if (conditionWords < 25) {
                document.getElementById('conditionReviewError').textContent = 'Please write at least 25 words';
                return;
            }
            
            // Clear error
            document.getElementById('conditionReviewError').textContent = '';
            
            // Save review data
            surveyData.responses.condition_review = document.getElementById('conditionReview').value;
            surveyData.responses.condition_review_word_count = conditionWords;
            surveyData.responses.review_submit_time = new Date().toISOString();
            
            // Show submitted state
            const reviewContainer = document.getElementById('reviewContainer');
            const reviewSubmitted = document.getElementById('reviewSubmitted');
            const lockedReview = document.getElementById('lockedReview');
            
            reviewContainer.style.display = 'none';
            reviewSubmitted.style.display = 'block';
            lockedReview.textContent = `"${document.getElementById('conditionReview').value}"`;
            
            // Show follow-up question (both conditions A and B have follow-up questions)
            const condition = conditions[surveyData.condition];
            document.getElementById('followUpQuestion').textContent = condition.followUpQuestion;
            document.getElementById('followUpSection').style.display = 'block';
            
            // Scroll to follow-up question
            setTimeout(() => {
                document.getElementById('followUpSection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        function nextBlock(blockNum) {
            console.log(`üîÑ Moving from block ${blockNum} to block ${blockNum + 1}`);
            
            // Special handling for follow-up question
            if (blockNum === 5) {
                const followupAnswer = document.querySelector('input[name="followup_comfort"]:checked');
                if (!followupAnswer) {
                    document.getElementById('followUpError').textContent = 'Please select your comfort level';
                    console.log('‚ùå Follow-up question not answered');
                    return;
                } else {
                    document.getElementById('followUpError').textContent = '';
                    surveyData.responses.followup_comfort = parseInt(followupAnswer.value);
                    console.log('‚úÖ Follow-up answer collected:', followupAnswer.value);
                }
            }
            
            if (blockNum > 0 && !validateCurrentBlock()) {
                console.log('‚ùå Block validation failed for block', blockNum);
                return;
            }
            
            if (blockNum > 0) {
                collectCurrentBlockData();
            }
            
            // Special handling for condition randomization after block 3
            if (blockNum === 3) {
                randomizeCondition();
                console.log('üé≤ Condition randomized to:', surveyData.condition);
            }
            
            // Hide current block
            if (blockNum === 0) {
                document.getElementById('block0').classList.remove('active');
                console.log('üëã Hidden block 0 (location)');
            } else {
                document.getElementById('block' + blockNum).classList.remove('active');
                console.log(`üëã Hidden block ${blockNum}`);
            }
            
            // Show next block
            currentBlock = blockNum + 1;
            document.getElementById('block' + currentBlock).classList.add('active');
            console.log(`üëÄ Showing block ${currentBlock}`);
            
            // Update progress
            updateProgress();
            console.log(`üìä Progress updated: ${(currentBlock / totalBlocks) * 100}%`);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        async function submitSurvey() {
            if (!validateCurrentBlock()) {
                return;
            }
            
            collectCurrentBlockData();
            
            // Hide current block and show completion
            document.getElementById('block6').classList.remove('active');
            document.getElementById('blockComplete').classList.add('active');
            
            // Update progress to 100%
            document.getElementById('progressFill').style.width = '100%';
            
            // Display data preview
            displayDataPreview();
            
            // Save data to server
            await saveDataToServer();
            
            console.log('Survey completed:', surveyData);
        }

        function displayDataPreview() {
            const preview = document.getElementById('dataPreview');
            preview.innerHTML = `
                <h4>Data Preview:</h4>
                <pre style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px; overflow-x: auto; max-height: 300px;">
${JSON.stringify(surveyData, null, 2)}
                </pre>
            `;
        }

        function downloadData() {
            const dataStr = JSON.stringify(surveyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `survey_data_${surveyData.participant_id}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function saveDataToServer() {
            try {
                console.log('üîÑ Attempting to save data to server...');
                console.log('üìä Current survey data:', JSON.stringify(surveyData, null, 2));
                console.log('üìç Current block:', currentBlock);
                console.log('üÜî Participant ID:', surveyData.participant_id);
                console.log('üéØ Prolific ID:', surveyData.responses?.prolific_id);
                
                // Don't save if we don't have essential data yet
                if (!surveyData.responses?.prolific_id) {
                    console.log('‚ö†Ô∏è Skipping save: No Prolific ID yet');
                    return false;
                }
                
                if (currentBlock < 2) {
                    console.log('‚ö†Ô∏è Skipping save: Still in early blocks');
                    return false;
                }
                
                const response = await fetch('/api/survey/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(surveyData)
                });
                
                console.log('üì° Server response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Data saved to server successfully:', result);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Server error response:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('üí• Error saving to server:', error);
                // Fallback to localStorage
                try {
                    localStorage.setItem(`survey_${surveyData.participant_id}`, JSON.stringify(surveyData));
                    console.log('üíæ Data saved to localStorage as fallback');
                } catch (localError) {
                    console.error('üí• Error saving to localStorage:', localError);
                }
                return false;
            }
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            requestLocation();
            updateProgress();
            
            // Check video loading when on video block
            checkVideoLoading();
            
            // Auto-save progress every 30 seconds
            setInterval(async () => {
                console.log('‚è∞ Auto-save interval triggered');
                console.log('üìç Current block:', currentBlock, '| Total blocks:', totalBlocks);
                console.log('üÜî Has Prolific ID:', !!surveyData.responses?.prolific_id);
                
                if (currentBlock <= totalBlocks && currentBlock > 1 && surveyData.responses?.prolific_id) {
                    console.log('‚úÖ Conditions met for auto-save, proceeding...');
                    await saveDataToServer();
                } else {
                    console.log('‚è≠Ô∏è Skipping auto-save - conditions not met');
                }
            }, 30000);
        });
        
        // Debug YouTube video loading
        function checkVideoLoading() {
            console.log('üé¨ Checking YouTube video embedding...');
            console.log('üìπ YouTube Video ID: TpDG2LS1YpQ');
            console.log('üîó YouTube URL: https://youtu.be/TpDG2LS1YpQ');
            
            // Check if iframe loads properly
            setTimeout(() => {
                const iframe = document.querySelector('iframe[src*="youtube.com/embed"]');
                if (iframe) {
                    console.log('‚úÖ YouTube iframe found in DOM');
                    console.log('üìê Iframe dimensions:', iframe.width, 'x', iframe.height);
                    console.log('üîó Iframe src:', iframe.src);
                    
                    // Check if iframe content loads
                    iframe.onload = function() {
                        console.log('‚úÖ YouTube iframe loaded successfully');
                    };
                    
                    iframe.onerror = function() {
                        console.error('‚ùå YouTube iframe failed to load');
                    };
                } else {
                    console.error('‚ùå YouTube iframe not found in DOM');
                }
            }, 1000);
        }
        
        // Add YouTube iframe event listeners for debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé¨ Setting up YouTube iframe monitoring...');
            
            // YouTube iframe doesn't have same events as video element
            // We check for iframe presence and loading
            setTimeout(() => {
                const iframe = document.querySelector('iframe[src*="youtube.com/embed"]');
                if (iframe) {
                    console.log('‚úÖ YouTube iframe detected in DOM');
                    
                    iframe.addEventListener('load', () => {
                        console.log('‚úÖ YouTube iframe finished loading');
                    });
                    
                    iframe.addEventListener('error', (e) => {
                        console.error('‚ùå YouTube iframe error:', e);
                    });
                } else {
                    console.log('‚è≥ YouTube iframe not yet in DOM, will check again...');
                }
            }, 500);
        });
    </script>
</body>
</html>
